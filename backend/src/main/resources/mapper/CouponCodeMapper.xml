<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.umxinli.mapper.CouponCodeMapper">
    
    <!-- 查询兑换码列表 -->
    <select id="selectCouponCodeList" resultType="java.util.Map">
        SELECT
            cc.id, cc.code, cc.coupon_id as couponId,
            cc.total_count as totalCount, cc.used_count as usedCount,
            cc.status, cc.created_at as createdAt, cc.updated_at as updatedAt,
            c.name as couponName
        FROM coupon_code cc
        LEFT JOIN coupon c ON cc.coupon_id = c.id
        <where>
            <if test="couponId != null">
                AND cc.coupon_id = #{couponId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (cc.code LIKE CONCAT('%', #{keyword}, '%') OR c.name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY cc.id DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计兑换码数量 -->
    <select id="countCouponCodeList" resultType="int">
        SELECT COUNT(*) FROM coupon_code cc
        LEFT JOIN coupon c ON cc.coupon_id = c.id
        <where>
            <if test="couponId != null">
                AND cc.coupon_id = #{couponId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (cc.code LIKE CONCAT('%', #{keyword}, '%') OR c.name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>
    
    <!-- 根据兑换码查找 -->
    <select id="selectByCode" resultType="com.umxinli.entity.CouponCode">
        SELECT * FROM coupon_code WHERE code = #{code}
    </select>
</mapper>

