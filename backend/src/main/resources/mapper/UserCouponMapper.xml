<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.umxinli.mapper.UserCouponMapper">

    <!-- 查询用户优惠券列表（含优惠券详情） -->
    <select id="selectUserCouponList" resultType="java.util.Map">
        SELECT
            uc.id, uc.user_id as userId, uc.coupon_id as couponId,
            uc.status, uc.receive_type as receiveType,
            uc.used_at as usedAt, uc.order_id as orderId, uc.created_at as createdAt,
            c.name as couponName, c.type as couponType,
            c.discount_amount as discountAmount, c.min_amount as minAmount,
            c.start_time as startTime, c.end_time as endTime,
            c.coach_scope as coachScope, c.coach_ids as coachIds,
            c.status as couponStatus,
            <!-- 判断优惠券是否已过期 -->
            CASE
                WHEN c.end_time IS NOT NULL AND c.end_time &lt; NOW() THEN 1
                ELSE 0
            END as isExpired
        FROM user_coupon uc
        LEFT JOIN coupon c ON uc.coupon_id = c.id
        <where>
            <if test="userId != null">
                AND uc.user_id = #{userId}
            </if>
            <!-- 查询可用优惠券：未使用且未过期 -->
            <if test="status != null and status == 0">
                AND uc.status = 0
                AND c.status = 1
                AND (c.end_time IS NULL OR c.end_time >= NOW())
                AND (c.start_time IS NULL OR c.start_time &lt;= NOW())
            </if>
            <!-- 查询不可用优惠券：已使用、已过期或优惠券模板已停用 -->
            <if test="status != null and status == 1">
                AND (
                    uc.status = 1
                    OR (c.end_time IS NOT NULL AND c.end_time &lt; NOW())
                    OR c.status = 0
                )
            </if>
        </where>
        ORDER BY uc.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计用户优惠券数量 -->
    <select id="countUserCouponList" resultType="int">
        SELECT COUNT(*) FROM user_coupon uc
        <where>
            <if test="userId != null">
                AND uc.user_id = #{userId}
            </if>
            <if test="status != null">
                AND uc.status = #{status}
            </if>
        </where>
    </select>

    <!-- 查询优惠券发放记录 -->
    <select id="selectCouponDistributionList" resultType="java.util.Map">
        SELECT
            uc.id, uc.user_id as userId, uc.status, uc.receive_type as receiveType,
            uc.used_at as usedAt, uc.created_at as createdAt,
            COALESCE(u.phone, CONCAT('用户', uc.user_id)) as userName,
            u.phone, u.avatar
        FROM user_coupon uc
        LEFT JOIN user u ON uc.user_id = u.id
        WHERE uc.coupon_id = #{couponId}
        ORDER BY uc.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计优惠券发放数量 -->
    <select id="countCouponDistribution" resultType="int">
        SELECT COUNT(*) FROM user_coupon WHERE coupon_id = #{couponId}
    </select>

    <!-- 批量插入用户优惠券 -->
    <insert id="batchInsertUserCoupon">
        INSERT INTO user_coupon (user_id, coupon_id, status, receive_type, created_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.userId}, #{item.couponId}, #{item.status}, #{item.receiveType}, NOW())
        </foreach>
    </insert>
</mapper>

