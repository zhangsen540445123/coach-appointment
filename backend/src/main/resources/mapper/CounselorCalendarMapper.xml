<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.umxinli.mapper.CounselorCalendarMapper">

    <resultMap id="counselorCalendarResultMap" type="com.umxinli.entity.CounselorCalendar">
        <id property="id" column="id"/>
        <result property="counselorId" column="counselor_id"/>
        <result property="date" column="date"/>
        <result property="startTime" column="start_time"/>
        <result property="consultWay" column="consult_way"/>
        <result property="consultType" column="consult_type"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="selectById" resultMap="counselorCalendarResultMap">
        SELECT * FROM counselor_calendar WHERE id = #{id}
    </select>

    <select id="selectByCounselorId" resultMap="counselorCalendarResultMap">
        SELECT * FROM counselor_calendar 
        WHERE counselor_id = #{counselorId}
        ORDER BY date, start_time
    </select>

    <select id="selectByCounselorIdAndDateRange" resultMap="counselorCalendarResultMap">
        SELECT * FROM counselor_calendar 
        WHERE counselor_id = #{counselorId}
        AND date >= #{startDate}
        AND date &lt;= #{endDate}
        ORDER BY date, start_time
    </select>

    <select id="selectAvailableByCounselorId" resultMap="counselorCalendarResultMap">
        SELECT * FROM counselor_calendar 
        WHERE counselor_id = #{counselorId}
        AND date >= #{startDate}
        AND date &lt;= #{endDate}
        AND status = 0
        ORDER BY date, start_time
    </select>

    <insert id="insert" parameterType="com.umxinli.entity.CounselorCalendar" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO counselor_calendar (
            counselor_id, date, start_time, consult_way, consult_type, status, created_at, updated_at
        ) VALUES (
            #{counselorId}, #{date}, #{startTime}, #{consultWay}, #{consultType}, #{status}, NOW(), NOW()
        )
    </insert>

    <insert id="batchInsert">
        INSERT INTO counselor_calendar (counselor_id, date, start_time, consult_way, consult_type, status, created_at, updated_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.counselorId}, #{item.date}, #{item.startTime}, #{item.consultWay}, #{item.consultType}, #{item.status}, NOW(), NOW())
        </foreach>
    </insert>

    <update id="update" parameterType="com.umxinli.entity.CounselorCalendar">
        UPDATE counselor_calendar SET
            date = #{date},
            start_time = #{startTime},
            consult_way = #{consultWay},
            consult_type = #{consultType},
            status = #{status},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="updateStatus">
        UPDATE counselor_calendar SET status = #{status}, updated_at = NOW() WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE FROM counselor_calendar WHERE id = #{id}
    </delete>

    <delete id="deleteByCounselorId">
        DELETE FROM counselor_calendar WHERE counselor_id = #{counselorId}
    </delete>

    <delete id="deleteByCounselorIdAndDate">
        DELETE FROM counselor_calendar WHERE counselor_id = #{counselorId} AND date = #{date}
    </delete>

    <!-- 查询指定日期范围内有可预约时间的教练ID列表 -->
    <select id="selectCounselorIdsWithAvailableSlots" resultType="java.lang.Long">
        SELECT DISTINCT counselor_id FROM counselor_calendar
        WHERE date >= #{startDate}
        AND date &lt;= #{endDate}
        AND status = 0
        ORDER BY counselor_id
    </select>

    <!-- 释放教练的预约时段（将已预约状态改为可预约） -->
    <update id="releaseSlot">
        UPDATE counselor_calendar
        SET status = 0, updated_at = NOW()
        WHERE counselor_id = #{counselorId}
        AND date = #{date}
        AND start_time = #{startTime}
        AND status = 1
    </update>

    <!-- 预约教练的时段（将可预约状态改为已预约） -->
    <update id="bookSlot">
        UPDATE counselor_calendar
        SET status = 1, updated_at = NOW()
        WHERE counselor_id = #{counselorId}
        AND date = #{date}
        AND start_time = #{startTime}
        AND status = 0
    </update>

</mapper>

