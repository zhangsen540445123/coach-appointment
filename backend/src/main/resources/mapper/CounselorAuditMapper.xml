<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.umxinli.admin.mapper.CounselorAuditMapper">

    <resultMap id="BaseResultMap" type="com.umxinli.admin.entity.CounselorAudit">
        <id column="id" property="id"/>
        <result column="counselor_id" property="counselorId"/>
        <result column="before_data" property="beforeData"/>
        <result column="after_data" property="afterData"/>
        <result column="audit_status" property="auditStatus"/>
        <result column="submitted_by" property="submittedBy"/>
        <result column="submitted_at" property="submittedAt"/>
        <result column="audited_by" property="auditedBy"/>
        <result column="audited_at" property="auditedAt"/>
        <result column="audit_remark" property="auditRemark"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM counselor_audit WHERE id = #{id}
    </select>

    <select id="selectByCounselorId" resultMap="BaseResultMap">
        SELECT * FROM counselor_audit 
        WHERE counselor_id = #{counselorId}
        ORDER BY created_at DESC
    </select>

    <select id="selectList" resultMap="BaseResultMap">
        SELECT * FROM counselor_audit
        <where>
            <if test="status != null">
                AND audit_status = #{status}
            </if>
            <if test="counselorId != null">
                AND counselor_id = #{counselorId}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="count" resultType="int">
        SELECT COUNT(*) FROM counselor_audit
        <where>
            <if test="status != null">
                AND audit_status = #{status}
            </if>
            <if test="counselorId != null">
                AND counselor_id = #{counselorId}
            </if>
        </where>
    </select>

    <select id="selectPendingByCounselorId" resultMap="BaseResultMap">
        SELECT * FROM counselor_audit 
        WHERE counselor_id = #{counselorId} AND audit_status = 0
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <insert id="insert" parameterType="com.umxinli.admin.entity.CounselorAudit">
        INSERT INTO counselor_audit (
            id, counselor_id, before_data, after_data, audit_status,
            submitted_by, submitted_at, created_at, updated_at
        ) VALUES (
            #{id}, #{counselorId}, #{beforeData}, #{afterData}, #{auditStatus},
            #{submittedBy}, #{submittedAt}, #{createdAt}, #{updatedAt}
        )
    </insert>

    <update id="updateStatus">
        UPDATE counselor_audit 
        SET audit_status = #{status},
            audited_by = #{auditedBy},
            audited_at = NOW(),
            audit_remark = #{auditRemark},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>

